# Reuirements

* Vagrant (https://www.vagrantup.com/downloads.html) minimum version 1.8.1
  * The [vagrant-vbguest](https://github.com/dotless-de/vagrant-vbguest) plugin is also required. Once vagrant is installed, run `vagrant plugin install vagrant-vbguest`
* Apache Solr 5.3 with solr-nexustiles-core core running on localhost (see solr-nexustiles-core.zip)
* Apache Cassandra 2.2.3 with nexustiles keyspace running on localhost (see cassandra-ddl.sql)

# Setup

1. Clone this repo: https://github.com/dataplumber/nexus.git
2. CD into `nexus/nexus-ingest/developer-box`
3. Run the command `vagrant up` (this will take some time, around 10-20 minutes, it’s going to download a bunch of stuff)
4. Once completed, run `vagrant ssh` to log in to your newly minted centos virtual machine.
5. Once ssh’ed in, run `/vagrant/user-init.sh /home/vagrant`
  * **NOTE** Part of this script will be cloning some git repos. In order to clone a JPL github repo you need a JPL github account, proper authorization for the repo, and an OAuth token. When running this script you will be prompted to enter an OAuth token. A token can be generated by going to https://github.com/settings/tokens
6. After that you should be able to go to http://localhost:9393/admin-ui/#/streams/definitions and you’ll see a number of streams.
7. When changes are made in the repository, ssh into the vagrant box and run `./user-update.sh /home/vagrant` to deploy the new changes (FYI - this script re-deploys everything)

## No Vagrant Setup

1. Install JDK 8, Maven 3.3.9, Git (latest), and Anaconda2 4.0
2. Create a conda environment and activate it
  1. conda install `libnetcdf` and `netcdf4`
3. Download the [Spring XD 1.3.1](http://repo.spring.io/libs-release/org/springframework/xd/spring-xd/1.3.1.RELEASE) distrobution zip
  1. Extract the zip to a folder `$springxd-home`
  2. Create directory `$springxd-home/spring-xd-1.3.1.RELEASE/xd/lib/none`
  3. Copy [xd-singlenode-logback.groovy](xd-singlenode-logback.groovy) to `$springxd-home/spring-xd-1.3.1.RELEASE/xd/config/xd-singlenode-logback.groovy`
  4. Start Spring XD in singlenode mode `nohup ./spring-xd-1.3.1.RELEASE/xd/bin/xd-singlenode --hadoopDistro none &` (logs will be in `$springxd-home/spring-xd-1.3.1.RELEASE/xd/logs/`)
4. Run `./user-init.sh $springxd-home $conda-environment-name`
5. When changes are made in the repository, run `./user-update.sh $springxd-home` to deploy the new changes (FYI - this script re-deploys everything)

# Working with the Environment

Now you have a centos virtualbox running on your local machine that has Spring XD installed and running in single node mode.

## Ingesting Data

Inside of the `developer-box` directory, you will notice a `data` directory with a number of sub-directories that coorespond to different datasets. If you copy a *.nc file into one of these directories and then deploy the dataset's corresponding stream, the *.nc files will begin to be ingested.

### Datasets

* MUR
  * Data directory: `data/mur`
  * Stream name: `ingest-mur`
* MUR Climatology
  * Data directory: `data/mur-clim`
  * Stream name: `ingest-mur`
* ASCATB L2 Coastal
  * Data directory: `data/ascatb`
  * Stream name: `ingest-ascatb-u` and `ingest-ascatb-v`
* AVHRR
  * Data directory: `data/avhrr`
  * Stream name: `ingest-avhrr`
* AVHRR Climatology
  * Data directory: `data/avhrr-clim`
  * Stream name: `ingest-avhrr-clim`
* MODIS Aqua L3
  * Data directory: `data/modis`
  * Stream name: `ingest-modis`
* MODIS Aqua L3 Climatology
  * Data directory: `data/modis-clim`
  * Stream name: `ingest-modis-clim`
* TRMM
  * Data directory: `data/trmm`
  * Stream name: `ingest-trmm`
* SMAP (**WORK IN PROGRESS**)
  * Data directory: `data/smap`
  * Stream name: `ingest-smap-sss`

## Interacting with the virtual machine

* **SSH** You can ssh into the running virtual machine by running `vagrant ssh` from the `developer-box` directory
* **Halt** To stop the virtual machine, run `vagrant halt` from the `developer-box` directory
* **Start** To start the virtual machine, run `vagrant up` from the `developer-box` directory
* **Destroy** To destroy the virtual machine, run `vagrant destroy` from the `developer-box` directory
  * **WARNING** This will remove all traces of the virtual machine. The next time you run `vagrant up` it will need to re-provision (i.e. download) all of the software again.
  
The `/developer-box` directory on the host machine is automatically shared with the virtual machine. It can be accessed in `/vagrant` from the virtual machine.

## Spring XD

Spring XD is running inside the virtual machine in single-node mode.  
It is installed in `/home/vagrant/spring-xd-1.3.1.RELEASE`.
Logs are written to `/vagrant/logs` which is also shared with the host machine and can be accessed from the host as `developer-box/logs`

* **Stopping** To stop Spring XD run `ps -ef | grep xd-singlenode` to get the PID of the XD process and then `kill $PID`
* **Starting** To start Spring XD run `/vagrant/start-singlenode-at-boot.sh`

### Opening a XD-Shell

ssh into the vagrant machine and run `~/spring-xd-1.3.1.RELEASE/shell/bin/xd-shell`

### Working with Streams

* **Deploying** There are two ways to deploy a stream:
  * Navigate to http://localhost:9393/admin-ui/#/streams/definitions and click on the `Deploy` button for the stream you want to deploy
  * Open an XD Shell and run `stream deploy --name name-of-stream`
* **Un-Deploying** There are two ways to undeploy a stream:
  * Navigate to http://localhost:9393/admin-ui/#/streams/definitions and click on the `Undeploy` button for the stream you want to deploy
  * Open an XD Shell and run `stream undeploy --name name-of-stream`
* **Destroying** There are two was to destroy a stream:
  * Navigate to http://localhost:9393/admin-ui/#/streams/definitions and click on the `Destroy` button for the stream you want to deploy
  * Open an XD Shell and run `stream destroy --name name-of-stream`
